<link rel="stylesheet" href="/static/style/profile-edit.css">

<div class="edit-profile-page">
    <div class="page-header">
        <button class="btn btn-back" data-content="profile">
            <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ –ø—Ä–æ—Ñ–∏–ª—é
        </button>
        <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</h2>
    </div>

    <div class="edit-form-container">
        <form id="basicProfileForm" class="profile-form">
            <div class="form-section">
                <h3>–õ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-first-name">–ò–º—è *</label>
                        <input type="text" id="edit-first-name" name="first_name" 
                               value="{{ current_user.first_name }}" required minlength="3" maxlength="50">
                        <small class="form-text">–û—Ç 3 –¥–æ 50 —Å–∏–º–≤–æ–ª–æ–≤</small>
                    </div>

                    <div class="form-group">
                        <label for="edit-last-name">–§–∞–º–∏–ª–∏—è *</label>
                        <input type="text" id="edit-last-name" name="last_name" 
                               value="{{ current_user.last_name }}" required minlength="3" maxlength="50">
                        <small class="form-text">–û—Ç 3 –¥–æ 50 —Å–∏–º–≤–æ–ª–æ–≤</small>
                    </div>
                </div>

                <div class="form-group">
                    <label for="edit-user-nick">–ù–∏–∫–Ω–µ–π–º *</label>
                    <input type="text" id="edit-user-nick" name="user_nick" 
                           value="{{ current_user.user_nick }}" required minlength="3" maxlength="50">
                    <small class="form-text">–¢–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è</small>
                    <div id="nick-availability" class="availability-status"></div>
                </div>
            </div>

            <div class="form-section">
                <h3>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                
                <div class="form-group">
                    <label for="edit-secondary-email">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π email</label>
                    <input type="email" id="edit-secondary-email" name="secondary_email" 
                           autocomplete="email" value="{{ current_user.secondary_email or '' }}"
                           onblur="checkSecondaryEmailAvailability(this.value)">
                    <small class="form-text">–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –ø–æ—á—Ç—ã</small>
                    <div id="secondary-email-availability" class="availability-status"></div>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" data-content="profile">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-primary" data-action="save-basic-profile">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            </div>
        </form>
    </div>
</div>

<script>
console.log('üîÑ edit_basic_profile.html –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
console.log('–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å updateBasicProfile –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ profile-edit.js:', typeof updateBasicProfile);
</script>

<script src="/static/js/profile-edit.js"></script>

<script>
console.log('üîÑ –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ profile-edit.js');
console.log('updateBasicProfile –¥–æ—Å—Ç—É–ø–Ω–∞:', typeof window.updateBasicProfile);
console.log('changePassword –¥–æ—Å—Ç—É–ø–Ω–∞:', typeof window.changePassword);

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîÑ DOM –∑–∞–≥—Ä—É–∂–µ–Ω –≤ edit_basic_profile.html');
    
    const nickInput = document.getElementById('edit-user-nick');
    const statusElement = document.getElementById('nick-availability');
    
    if (nickInput && statusElement) {
        nickInput.addEventListener('blur', function() {
            checkNicknameAvailability(this, statusElement);
        });
    }

    const form = document.getElementById('basicProfileForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('üìù –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞, –≤—ã–∑—ã–≤–∞–µ–º handleAction');
            const submitButton = this.querySelector('[data-action="save-basic-profile"]');
            if (submitButton) {
                handleAction('save-basic-profile', submitButton, e);
            }
        });
    }
    
    console.log('‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
});

function checkSecondaryEmailAvailability(email) {
    const statusElement = document.getElementById('secondary-email-availability');
    
    if (!statusElement) return;
    
    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –∏–ª–∏ email —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π
    if (!email || email.length < 3) {
        statusElement.innerHTML = '';
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        statusElement.innerHTML = '<span class="text-danger">‚úó –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email</span>';
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å –æ—Å–Ω–æ–≤–Ω—ã–º email
    const mainEmail = '{{ current_user.user_email }}';
    if (email === mainEmail) {
        statusElement.innerHTML = '<span class="text-danger">‚úó –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π email –Ω–µ –º–æ–∂–µ—Ç —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –æ—Å–Ω–æ–≤–Ω—ã–º</span>';
        return;
    }
    
    statusElement.innerHTML = '<span class="text-warning">‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏...</span>';
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    fetch(`/users/check-secondary-email?email=${encodeURIComponent(email)}`)
        .then(response => response.json())
        .then(data => {
            if (data.available) {
                statusElement.innerHTML = '<span class="text-success">‚úì Email –¥–æ—Å—Ç—É–ø–µ–Ω</span>';
            } else {
                statusElement.innerHTML = '<span class="text-danger">‚úó Email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è</span>';
            }
        })
        .catch(error => {
            statusElement.innerHTML = '<span class="text-warning">‚ö† –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏</span>';
        });
}

// –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª—è
document.getElementById('edit-secondary-email').addEventListener('input', function() {
    const statusElement = document.getElementById('secondary-email-availability');
    if (statusElement) {
        statusElement.innerHTML = '';
    }
});
</script>